#! /usr/bin/env python3

import os
import subprocess
import sys


def prepDirectory(projectDir):
  if os.path.exists(projectDir):
    sys.exit(f"ERROR: Directory {projectDir} already exists")
  else:
    os.makedirs(projectDir)


# Execute a function after chdir to the supplied directory, restoring the
# working directory afterwards.
def withDirectory(dir, f):
  cwd = os.getcwd()

  try:
    os.chdir(dir)
    f()
  finally:
    os.chdir(cwd)


def mkVirtEnv(projectDir, defaultVenvDir):
  venvDir = input(f"Virtual environment directory (default {defaultVenvDir} under {projectDir})? ")
  if venvDir == '':
    venvDir = defaultVenvDir

  def f():
    subprocess.call(["python3", "-m", "venv", venvDir])
    subprocess.call([f"{venvDir}/bin/python", "-m", "pip", "install",
      "--upgrade", "pip", "setuptools", "wheel"])

  withDirectory(projectDir, f)

  return venvDir


def mkGitignore(projectDir, venvDir):
  gitIgnoreFile = f'{projectDir}/.gitignore'

  if os.path.exists(gitIgnoreFile):
    print(f"{gitIgnoreFile} already exists, not creating")
  else:
    with open(gitIgnoreFile, "w") as f:
      f.write(f"{venvDir}\n")
    print(f"{gitIgnoreFile} created")


def printSuccessMsg(projectDir, venvDir):
  print(
    f"\nVirtual environment is ready for project in {projectDir}\n\n"

     "Useful commands:\n\n"

    f"$ cd {projectDir}\n"
     "$ git init  # and then more git commands\n"
    f"$ . ./{venvDir}/bin/activate\n"
     "$ pip install SOME_PYTHON_PACKAGE\n"
     "$ pip freeze > requirements.txt  # Not a bad idea to put requirements.txt in source control\n"
     "$ deactivate\n"
    )


def main():
  defaultVenvDir = ".venv"

  if len(sys.argv) < 2:
    sys.exit("Usage: new-py PROJECT_DIR")

  projectDir = sys.argv[1]

  prepDirectory(projectDir)
  venvDir = mkVirtEnv(projectDir, defaultVenvDir)
  mkGitignore(projectDir, venvDir)
  printSuccessMsg(projectDir, venvDir)


if __name__ == '__main__': main()
